<!DOCTYPE HTML>
<html>
    <head>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    </head>
    <body>
        <div id="theHeatmap" style="width: 1024px; height: 768px;">
            <!-- Ploty heatmap placeholder -->
        </div>
        <script type="text/javascript">
            // Create the default heat map layout

            var xData = [[]];
            var inc = 0;

            for (i = 0; i < 10; i++) {
              var yData = [];
              for (j = 0; j < 10; j++) {
                yData[j] = 1000;
              }
              xData[i] = yData;
              inc++;
            }

            var data = [
              {
                z: this.xData,
                type: "heatmap",
                colorscale: 'YIOrRd'
              }
            ];

            Plotly.plot("theHeatmap", data);

            // Set up the WS stuff

            var numbers = [];
            for (i = 0; i < 100; i++) {
              numbers[i] = i;
            }

            // make the array contain a random order so that we send messages to the backend for random positions (makes the heat map more interesting)
            var i = numbers.length;
            while(i--) {
                var toPos = Math.floor(Math.random() * i);
                var iValue = numbers[i];
                var toValue = numbers[toPos];
                numbers[i] = toValue;
                numbers[toPos] = iValue;
            }

            var ws = new WebSocket("ws://localhost:8080/ws");
            ws.onopen = function() {
                for(i = 0; i < numbers.length; i++) {
                    sendPositionData(numbers[i]);
                }
            }

            var sendPositionData = function(pos) {
                ws.send(pos + ":" + (new Date().getTime()));
            }

            var updates = 0;

            ws.onmessage = function(evt) {
                var msg = evt.data;
                var pos = msg.substring(0, msg.indexOf(":"));
                var timestamp = msg.substring(msg.indexOf(":") + 1, msg.length);
                var posX = Math.floor(pos / 10);
                var posY = pos - (posX * 10);
                xData[posX][posY] = new Date().getTime() - timestamp;
                sendPositionData(pos);

                // Only redraw every 10th update to help the browser a little...
                if (updates++ % 10 == 0) {
                    Plotly.redraw("theHeatmap", data);
                }
            }

            // TODO: set up thread that updates heatmap with new values (decaying func).
        </script>
    </body>
</html>